---
layout: mypost
title: 03-策略和回测系统
categories: [Python, Pandas, Numpy]
---

## CHLCV数据

> K线
> + 蜡烛线一种反映价格走势的图线

![k-pic](/py_core/assets/04-practice/03/k-pic.png)

- 每一个小蜡烛，都代表着当天的开盘价（Open）、最高价（High）、最低价（Low）和收盘价（Close）

![candle](/py_core/assets/04-practice/03/candle.png)

- 每一个小蜡烛，都代表着当天的开盘价（Open）、最高价（High）、最低价（Low）和收盘价（Close）

- 小时K线图
  - 每一笔交易的价格和数量。
  - 从上午 10:00 开始，我们开始积累 tick 的交易数据，以 10:00 开始的第一个交易作为 Open 数据，11:00 前的最后一笔交易作为 Close 值，并把这一个小时最低和最高的成交价格分别作为 High 和 Low 的值，我们就可以绘制出这一个小时对应的“小蜡烛”形状了。
  - 如果再加上这一个小时总的成交量（Volumn），就得到了 OHLCV 数据

## 使用 Gemini 从 2015 年到 2019 年 7 月这个时间内，BTC 对 USD 每个小时的 OHLCV 数据，作为策略和回测的输入

> 代码

```python
import pandas as pd
import os


def assert_msg(condition, msg):
    if not condition:
        raise Exception(msg)


def read_csv_file(filename):
    # 获取文件绝对路径
    filepath = os.path.join(os.path.dirname(__file__), filename)
    # 判断文件是否存在
    assert_msg(os.path.exists(filepath), "file noe found")
    # 读取csv文件并返回
    return pd.read_csv(filepath, index_col=0, parse_dates=True, infer_datetime_format=True)


BTCUSD = read_csv_file("BTCUSD_GEMINI.csv")
assert_msg(BTCUSD.__len__() > 0, "read failed")
print(BTCUSD.head())
```

> 输出结果

```csv
                     Symbol      Open      High       Low     Close     Volume
Date                                                                          
2019-07-08 00:00:00  BTCUSD  11475.07  11540.33  11469.53  11506.43  10.770731
2019-07-07 23:00:00  BTCUSD  11423.00  11482.72  11423.00  11475.07  32.996559
2019-07-07 22:00:00  BTCUSD  11526.25  11572.74  11333.59  11423.00  48.937730
2019-07-07 21:00:00  BTCUSD  11515.80  11562.65  11478.20  11526.25  25.323908
2019-07-07 20:00:00  BTCUSD  11547.98  11624.88  11423.94  11515.80  63.211972
```

> 函数说明

- read_csv_file()
  - pandas读取文件

- assert_msg()
  - 类似于 assert，如果传入的条件（contidtion）为否，就会抛出异常。不过，你需要提供一个参数，用于指定要抛出的异常信息

## 回测框架

- 向量化回测框架
  - 基于Pandas+Numpy构建计算核心
  - Mysql/MongoDB作为数据源

- 事件驱动型回测框架
  - 针对每一个 tick 的变动或者 orderbook 的变动生成事件；然后，再把一个个事件交给策略进行执行
  - Zipline
  - PyAlgoTrade

- 回测流程
  - 1.读取OHLC数据
  - 2.对OHLC数据进行指标运算
  - 3.策略根据指标向量决定买卖
  - 4.发给模拟的"交易所"进行交易
  - 5.统计结果

